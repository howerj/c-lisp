
# modules to compile, system dependent modules are added later.
MODULES=liblisp_crc.$(DLL)\
       	liblisp_bignum.$(DLL) liblisp_math.$(DLL) liblisp_line.$(DLL)\
	liblisp_text.$(DLL) 

MOD_DEPS=liblisp.h liblisp.a liblisp.$(DLL)

CURDIR:=mod$(FS)

ifeq ($(OS),Windows_NT)
ADDITIONAL=liblisp.$(DLL)
else # unix is default
MODULES+=liblisp_tcc.$(DLL) liblisp_sql.$(DLL) liblisp_unix.$(DLL)\
	 liblisp_x11.$(DLL)
endif

modules: $(MODULES)

%.o: $(CURDIR)%.c
	$(CC) $(CFLAGS) -I. $< -c -o $@

liblisp_line.o: $(CURDIR)liblisp_line.c $(MOD_DEPS)
	$(CC) $(CFLAGS) -I. -I$(CURDIR)libline $< -c -o $@

liblisp_sql.$(DLL): liblisp_sql.o $(MOD_DEPS)
	$(CC) $(CFLAGS) -shared $< $(ADDITIONAL) -lsqlite3 -o $@

liblisp_unix.$(DLL): liblisp_unix.o $(MOD_DEPS)
	$(CC) -Wall -Wextra -std=gnu99 -shared $< $(ADDITIONAL) -o $@

liblisp_crc.$(DLL): liblisp_crc.o crc.o $(MOD_DEPS)
	$(CC) $(CFLAGS) -shared $< crc.o $(ADDITIONAL) -o $@

liblisp_tcc.o: $(CURDIR)liblisp_tcc.c
	$(CC) $(CFLAGS_RELAXED) -I. $< -c -o $@

liblisp_tcc.$(DLL): liblisp_tcc.o $(MOD_DEPS)
	$(CC) $(CFLAGS) -shared $< $(ADDITIONAL) -ltcc -o $@

liblisp_math.$(DLL): liblisp_math.o $(MOD_DEPS)
	$(CC) $(CFLAGS) -shared $< $(ADDITIONAL) -lm -o $@

liblisp_line.$(DLL): liblisp_line.o libline.$(DLL) $(MOD_DEPS)
	$(CC) $(CFLAGS) -shared $< $(ADDITIONAL) -L. -lline -o $@

liblisp_x11.$(DLL): liblisp_x11.o $(MOD_DEPS)
	$(CC) $(CFLAGS) -shared $< $(ADDITIONAL) -lX11 -o $@

liblisp_text.$(DLL): liblisp_text.o diff.o tsort.o $(MOD_DEPS)
	$(CC) $(CFLAGS) -shared $< diff.o tsort.o $(ADDITIONAL) -o $@

liblisp_bignum.$(DLL): liblisp_bignum.o bignum.o $(MOD_DEPS)
	$(CC) $(CFLAGS) -shared $< bignum.o $(ADDITIONAL) -o $@

libline.$(DLL):
	make -C $(CURDIR)libline
	$(CP) $(CURDIR)libline$(FS)libline.$(DLL) .

